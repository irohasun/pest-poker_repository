# PEST POKER - ゲームアプリ 仕様書

**アプリ名:** PEST POKER（ペストポーカー）  
**バージョン:** 2.1
**作成日:** 2025年1月
**ドキュメント種別:** 機能仕様書

---

## 目次

1. [概要](#1-概要)
2. [ゲームルール](#2-ゲームルール)
3. [画面設計](#3-画面設計)
4. [データ構造](#4-データ構造)
5. [UI/UXガイドライン](#5-uiuxガイドライン)
6. [技術仕様](#6-技術仕様)
7. [セキュリティとプライバシー](#7-セキュリティとプライバシー)
8. [エラーハンドリング](#8-エラーハンドリング)
9. [追加機能](#9-追加機能優先度別)
10. [テスト計画](#10-テスト計画)
11. [リリース計画](#11-リリース計画)
12. [付録](#12-付録)

---

## 1. 概要

### 1.1 アプリの目的

オフラインで1台のスマートフォンを共有し、複数人でブラフ系カードゲーム「PEST POKER（ペストポーカー）」を楽しむアプリ

### 1.2 基本コンセプト

- **アプリ名**: PEST POKER（害虫ポーカー）
- **物理カード不要**: スマホ1台があれば遊べる
- **スマホ共有型**: 順番に回して使用
- **プレイ人数**: 2〜6人
- **プレイ時間**: 約20分
- **ゲームジャンル**: ブラフ・心理戦

### 1.3 ゲームの目的

8種類の「害虫（PEST）」カードを押し付け合い、**敗者1人を決める**ゲーム

### 1.4 主な特徴

- オフライン完結（インターネット接続不要）
- シンプルなルール、深い戦略性
- 対面でのコミュニケーションを重視
- 覗き見防止機能搭載

---

## 2. ゲームルール

### 2.1 カード構成

**全64枚**: 8種類の生き物が各8枚ずつ

#### 害虫カードの種類

1. コウモリ 🦇 (Bat)
2. クモ 🕷️ (Spider)
3. サソリ 🦂 (Scorpion)
4. ネズミ 🐭 (Mouse)
5. カエル 🐸 (Frog)
6. ハエ 🪰 (Fly)
7. カメムシ 🪲 (Stink Bug)
8. ムカデ 🦟 (Centipede)

### 2.2 ゲームの準備

#### 手順

1. プレイヤー人数（2〜6人）を決定
2. 各プレイヤーの名前を入力
3. **2人プレイの場合、特殊ルール適用**（後述）
4. カードを均等に配布（余ったカードは使用しない）
5. **各プレイヤーが手札を確認し、1枚を場に出す**（必須）
   - 手札から1枚を選択
   - 選択したカードは手札から削除され、公開カードとして場に置かれる
   - これにより、ゲーム開始時点で各プレイヤーに公開カードが1枚ずつ存在する
6. **初期の親（出題者）を手動で決定**
   - 全員の手札確認後、出題者決定画面が表示される
   - 場の状況（誰が何を場に出したか）を確認しながら、最初の出題者をタップして選択する
   - 選択されたプレイヤーからゲームが開始される

#### カード配布枚数

| 人数 | 使用カード | 除外カード | 1人あたりの枚数 | 余りカード |
|------|-----------|-----------|----------------|-----------|
| 2人 | 54枚 | 10枚（ランダム）| 27枚 | 0枚 |
| 3人 | 64枚 | 0枚 | 21枚 | 1枚 |
| 4人 | 64枚 | 0枚 | 16枚 | 0枚 |
| 5人 | 64枚 | 0枚 | 12枚 | 4枚 |
| 6人 | 64枚 | 0枚 | 10枚 | 4枚 |

#### 2人プレイ時の特殊ルール

**問題点：**
- 2人で全64枚を使うと、相手の手札が完全に推測できてしまう
- 心理戦の要素が失われる

**解決策：**
1. ゲーム開始前に、**10枚をランダムに除外**
2. 残った54枚を27枚ずつ配布
3. 除外されたカードは誰にも見せない
4. どのカードが除外されたかは不明のまま進行

**戦略的意義：**
- 相手の手札が完全には分からない
- 除外カードの推測も戦略の一部
- ブラフが有効に機能する

**実装上の注意：**
- 除外カードは完全にランダム
- 除外カードの情報はゲーム終了まで非表示
- デバッグ用には除外カードを記録

### 2.3 ターンの流れ

#### フェーズ1: 出題者のアクション

**重要：統合設定画面（アコーディオンUI）**
出題者のアクション（相手選択、カード選択、宣言選択）は、**1つの統合された設定画面**で順次行われます。アコーディオンUIにより、各ステップを選択すると次のステップが自動的に展開されます。

1. **ステップ1: 誰に渡しますか？（相手選択）**
   - 自分以外のプレイヤーリストから1人選ぶ
   - 各プレイヤーの状態（公開カード、危険度）を確認可能
   - 選択すると自動的に次のステップ（カード選択）が展開され、相手選択部分は選択結果のみの表示（プレビュー）に切り替わる

2. **ステップ2: どのカードを渡しますか？（カード選択）**
   - 自分の手札から渡したいカードを1枚選ぶ
   - 手札は種類ごとに整理して表示される
   - 選択すると自動的に次のステップ（宣言選択）が展開され、カード選択部分はプレビューに切り替わる

3. **ステップ3: 何だと宣言しますか？（宣言選択）**
   - 8種類の生き物から1つ選んで宣言する
   - **本当でも嘘でも良い**
   - 選択した時点で全てのステップが完了し、プレビュー状態になる

4. **決定して渡す**
   - 全ての項目が選択された状態でのみ「決定して渡す」ボタンが有効になる
   - ボタンを押すと回答者のターンへ遷移する

※ 各ステップは、選択後もプレビュー部分をタップすることで再度展開し、変更が可能。

#### フェーズ2: 回答者のアクション

回答者は以下の**3つの選択肢**から1つを選ぶ：

##### 選択肢A: 「本当」と判定

- カードをめくって確認
- 宣言が正しければ → カードは**出題者**の前に置かれる
  - 出題者がカードを引き取る
- 宣言が間違いなら → カードは**回答者**の前に置かれる
  - 回答者がカードを引き取る

##### 選択肢B: 「嘘」と判定

- カードをめくって確認
- 宣言が嘘なら → カードは**出題者**の前に置かれる
  - 出題者がカードを引き取る
- 宣言が本当なら → カードは**回答者**の前に置かれる
  - 回答者がカードを引き取る

##### 選択肢C: 他のプレイヤーに渡す

**⚠️ 重要：カード確認は必須**

1. **カードの確認（必須）**
   - 回答者は**必ず**カードの内容を確認する
   - 確認せずに渡すことはできない
   - 他のプレイヤーには見えないように配慮が必要
   - 確認画面で実際のカードと前の宣言の真偽が表示される
   
2. 次の相手を選択
   - **制約**: このターンで既に出題した人は除外
   - 渡せる相手がいない場合、必ず判定
   
3. 宣言する生き物を選択
   - 確認したカードの内容を基に、何を宣言するか決める
   - 前の宣言と同じでも違っても良い
   - 本当でも嘘でも良い

4. その相手が新しい回答者となる

**戦略的意義：**
- カードの内容を知った上で、どう宣言するかを決められる
- ポーカーフェイスが重要（確認後の表情管理）
- 本当のことを言うか、あえて嘘をつくかの駆け引き
- 確認した時点で判定には戻れない（一方通行）

#### フェーズ3: 結果確認と次のターン

1. **カード引き取りの確定**
   - カードが引き取られたプレイヤーの状態確認
   - 敗北判定のチェック

2. **次の出題者の決定**
   
   **🎯 重要ルール：次の出題者は必ずカードを引き取った人**
   
   - カードを引き取ったプレイヤーが次の出題者になる
   - これは必ず守らなければならないルール
   
   **具体例：**
   
   ```
   ケース1: 出題者が当てられた場合
   太郎（出題者）→ 花子に渡す
   花子が「本当」と判定 → 正解
   → カードは太郎の前に置かれる
   → 次の出題者は太郎
   ```
   
   ```
   ケース2: 回答者が外した場合
   太郎（出題者）→ 花子に渡す
   花子が「嘘」と判定 → 不正解（本当だった）
   → カードは花子の前に置かれる
   → 次の出題者は花子
   ```
   
   ```
   ケース3: 他の人に渡し続けた場合
   太郎 → 花子 → 次郎 → 三郎
   三郎が「本当」と判定 → 不正解
   → カードは三郎の前に置かれる
   → 次の出題者は三郎
   ```

3. **次のターンへ移行**
   - カードを引き取った人が新しい出題者としてターン開始
   - ゲームメイン画面に戻る

### 2.4 敗北条件

以下のいずれか1つを満たした時点で敗北：

1. **同じ種類のカードが4枚揃った**
   - 例: ゴキブリ×4

2. **8種類全てのカードが揃った**
   - 各種類1枚以上

3. **手札がない状態で出題できない**
   - 出題者のターンで手札が0枚の場合

#### 敗北条件の詳細判定

**【条件1・2の場合】**
- カードを「引き取った瞬間」に判定
- **引き取った人が敗北**

**【条件3の場合】**
- 出題者になった時に手札が0枚なら敗北
- **ただし例外：**
  - 最後の1枚を出して、相手に押し付けた場合は敗北しない
  - 次のターンは他の人が出題者になる
  - しかし、カードが戻ってきた場合（判定失敗）は敗北

#### エッジケースの処理

**ケース1: 同時敗北**
```
状況：
太郎が花子にカードを渡す
→ 花子が判定に失敗してカードを引き取る
→ 花子のクモが4枚になった

判定：
花子が敗北（カードを引き取った人）
```

**ケース2: 手札0枚 - 押し付け成功**
```
状況：
太郎（手札1枚）が花子にカードを渡す
→ 花子が判定ミス
→ カードが花子に残る

判定：
太郎の手札は0枚だが、カードを押し付けに成功
→ 太郎は敗北しない
→ 次のターンは花子が出題者
```

**ケース3: 手札0枚 - 押し付け失敗**
```
状況：
太郎（手札1枚）が花子にカードを渡す
→ 花子が正しく判定
→ カードが太郎に戻る

判定：
太郎（手札1枚）が再び出題者
→ しかし、すでに1枚出しているので手札0枚
→ 太郎は敗北
```

**ケース4: 全員が「渡す」を選択**
```
状況：
太郎 → 花子にカードを渡す（出題済み）
花子 → 次郎に渡す（出題済み）
次郎 → 三郎に渡す（出題済み）
三郎 → 全員が出題済みのため、誰にも渡せない

判定：
三郎は強制的に「本当」か「嘘」を判定
```

### 2.5 ゲーム終了

- 1人が敗北条件を満たした時点で終了
- その1人が**敗者**
- 残り全員が**勝者**

### 2.6 ゲームの戦略ポイント

#### 出題者の戦略

- 誰に押し付けるか
- 本当のことを言うか、嘘をつくか
- 自分の表情管理

#### 回答者の戦略

- 相手の表情を読む
- 場の状況から推理する
- リスクを取るか、安全に他の人に回すか

---

## 3. 画面設計

### 3.1 画面一覧

| No. | 画面名 | 説明 |
|-----|--------|------|
| 1 | タイトル画面 | アプリ起動時の最初の画面 |
| 2 | プレイヤー登録画面 | 人数と名前を入力 |
| 3 | ゲーム説明画面 | ルール説明 |
| 4 | 初期手札確認画面 | ゲーム開始時に全員が順番に手札確認 |
| 5 | 出題者決定画面 | 手札確認後、最初の出題者を決定（新規追加） |
| 6 | ゲームメイン画面 | 現在の状況を表示 |
| 7 | 出題設定画面 | 相手・カード・宣言を一括設定する画面（統合版） |
| 8 | 回答者：判定・場の状況確認画面 | 判定前に状況確認 |
| 9 | 回答者：カード確認画面 | 渡す場合のカード確認 |
| 10 | 回答者：相手選択画面 | 渡す相手を選ぶ |
| 11 | 回答者：宣言選択画面 | 何を宣言するか選ぶ |
| 12 | カードめくり演出画面 | 判定結果の表示 |
| 13 | 結果確認画面 | ターン結果のサマリー |
| 14 | ゲーム終了画面 | 勝敗結果の表示 |
| 15 | 一時停止画面 | ゲーム中断時 |

### 3.2 画面遷移図

```
[タイトル画面]
    ↓
[プレイヤー登録画面]
    ↓
[初期手札確認画面] (全員順番に)
    ↓
[出題者決定画面]
    ↓
[ゲームメイン画面] ←─────────────┐
    ↓ (出題者の場合、自動遷移)        │
[出題設定画面] (アコーディオン式)     │
    ・相手選択                        │
    ・カード選択                      │
    ・宣言選択                        │
    ↓                                │
[回答者：判定・場の状況確認]          │
    ├→ [本当/嘘を選択]               │
    │     ↓                          │
    │  [カードめくり演出]             │
    │     ↓                          │
    │  [結果確認]                    │
    │     ↓                          │
    │  🎯 カードを引き取った人が      │
    │     次の出題者になる ──────────┘
    │
    └→ [他の人に渡す]
          ↓
       [カード確認]（必須）
          ↓
       [相手選択]
          ↓
       [宣言選択]
          ↓
       （回答者画面に戻る）
       
※ 最終的にカードを引き取った人が次の出題者
```

### 3.3 各画面の詳細仕様

#### 3.3.1 タイトル画面
（変更なし：v2.0参照）

#### 3.3.2 プレイヤー登録画面
（変更なし：v2.0参照）

#### 3.3.3 初期手札確認画面
（変更なし：v2.0参照）

#### 3.3.4 出題者決定画面
（変更なし：v2.0参照）

#### 3.3.5 ゲームメイン画面
（変更なし：v2.0参照）

#### 3.3.6 出題設定画面（統合版・新規）

**目的**: 出題に必要な3つの要素（相手・カード・宣言）を一画面で効率的に設定する

**特徴**: アコーディオンUIを採用し、上から順に選択していくことでスムーズな設定を可能にする。

**レイアウト・挙動**:

```
┌───────────────────────────────┐
│ 出題の設定                     │
├───────────────────────────────┤
│                               │
│ ▼ 1. 誰に渡しますか？          │ (展開中)
│ ┌─────────┐ ┌─────────┐   │
│ │ 👤 花子 │ │ 👤 次郎 │   │
│ └─────────┘ └─────────┘   │
│  (タップで選択)                │
│                               │
├───────────────────────────────┤
│                               │
│ ▶ 2. どのカードを渡しますか？   │ (未選択・折りたたみ)
│                               │
├───────────────────────────────┤
│                               │
│ ▶ 3. 何だと宣言しますか？       │ (未選択・折りたたみ)
│                               │
├───────────────────────────────┤
│                               │
│   [決定して渡す] (無効)        │
│                               │
└───────────────────────────────┘
```

**選択後の状態**:

```
┌───────────────────────────────┐
│ 出題の設定                     │
├───────────────────────────────┤
│                               │
│ ▶ 1. 誰に渡しますか？          │ (完了・折りたたみ)
│   [👤 花子] (プレビュー)       │
│                               │
├───────────────────────────────┤
│                               │
│ ▼ 2. どのカードを渡しますか？   │ (自動展開)
│ ┌──┐  ┌──┐  ┌──┐      │
│ │🦇│  │🕷️│  │🐭│ ...    │
│ └──┘  └──┘  └──┘      │
│                               │
├───────────────────────────────┤
│                               │
│ ▶ 3. 何だと宣言しますか？       │ (未選択・折りたたみ)
│                               │
└───────────────────────────────┘
```

**機能要件**:
- **アコーディオン展開**: 現在選択すべきステップのみが展開される。
- **自動遷移**: 項目を選択すると、自動的にそのセクションが閉じ、次のセクションが展開される。
- **プレビュー表示**: 選択済みのセクションは閉じた状態で、選択したアイテム（プレイヤー、カード画像、宣言画像）が表示される。
- **再編集**: プレビュー部分をタップすると、再度そのセクションが展開され、選択を変更できる。
- **決定ボタン**: 全ての項目（相手、カード、宣言）が選択された状態でのみ有効化される。
- **ビジュアル**:
  - 選択状態は背景色の変化などで表現（赤枠は削除）。
  - プレビュー時のアイテムサイズは選択時と同じ大きさを維持。
  - 不要なテキスト（「変更」バッジなど）は削除し、シンプルに。

#### 3.3.9 回答者：判定・場の状況確認画面
（変更なし：v2.0参照）

**カード表示の詳細**:
```
実装イメージ：

1枚の場合:
┌──────┐
│ 🦇   │
│(画像)│
└──────┘

2枚の場合:
┌──────┐
│ 🦇   │┐
│(画像)││
└──────┘┘

3枚の場合:
┌──────┐
│ 🐸   │┐┐
│(画像)│││
└──────┘┘┘

4枚の場合（危険）:
┌──────┐
│ 🐸   │┐┐┐
│(画像)││││ ⚠️
└──────┘┘┘┘
```

**ビジュアル仕様**:
- **画像中心のデザイン**: 生物名や数字のテキスト表示を廃止
- **フルサイズ表示**: 画像をカード枠いっぱいに表示（パディングなし）
- **スタック表現**: 重なりによって枚数を視覚的に表現
- **クリーンな見た目**: 通常時の枠線を削除（危険時のみ赤枠表示）
- カードをタップで拡大表示（詳細確認）

#### 3.3.10 カードめくり演出画面
（変更なし：v2.0参照）

#### 3.3.11 結果確認画面
（変更なし：v2.0参照）

#### 3.3.12 回答者：カード確認画面
（変更なし：v2.0参照）

#### 3.3.13 回答者：相手選択画面
（変更なし：v2.0参照）

#### 3.3.14 ゲーム終了画面
（変更なし：v2.0参照）

#### 3.3.15 一時停止画面
（変更なし：v2.0参照）

---

## 4. データ構造
（変更なし：v2.0参照）

---

## 5. UI/UXガイドライン
（変更なし：v2.0参照）

---

## 6. 技術仕様
（変更なし：v2.0参照）

---

## 7. セキュリティとプライバシー
（変更なし：v2.0参照）

---

## 8. エラーハンドリング
（変更なし：v2.0参照）

---

## 9. 追加機能（優先度別）
（変更なし：v2.0参照）

---

## 10. テスト計画
（変更なし：v2.0参照）

---

## 11. リリース計画
（変更なし：v2.0参照）

---

## 12. 付録

### 12.4 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2025-01-23 | 2.0 | 画像ベースのリッチUIへ刷新（絵文字廃止）、出題者手動決定フローの導入、カード表示のシンプル化（テキスト削除） | - |
| 2025-01-23 | 2.1 | 出題フローのUI刷新：相手選択・カード選択・宣言選択を1つのアコーディオン式画面に統合。操作性の向上と画面遷移の削減を実施。 | - |

---

**最終更新**: 2025年1月  
**次回レビュー予定**: 開発開始後1週間

